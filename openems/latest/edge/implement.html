<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implementing a device :: Open Energy Management System</title>
    <link rel="canonical" href="http://openems.io/openems/latest/edge/implement.html">
    <meta name="keywords" content="AsciiDoc">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/feneco.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../_/css/vendor/docsearch.min.css">  </head>
  <body class="article">
<header class="header">
  <nav class="navbar" color="#2d8fab">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://github.com/OpenEMS/openems">OpenEMS // Docs</a>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/OpenEMS/openems">
          <span class="gitlink">
          </span>
        </a>
      </div>
    </div>
  </nav>
</header><div class="main-wrapper">
<div class="navigation-container" data-component="openems" data-version="latest">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../introduction.html">Open Energy Management System</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../openems_as.html">OpenEMS Association</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../gettingstarted.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../coreconcepts.html">Core concepts &amp; terminology</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">OpenEMS Edge</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hardware.html">Hardware</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="scheduler.html">Scheduler</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="controller.html">Controller</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="implement.html">Implementing a Device</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="build.html">Build OpenEMS Edge</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deploy.html">Deploy OpenEMS Edge</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">OpenEMS UI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ui/build.html">Build OpenEMS UI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">OpenEMS Backend</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backend/architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backend/configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backend/backend-to-backend.html">Backend-to-Backend</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../component-communication/index.html">Component Communication</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../simulation.html">Simulation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../documentation.html">Documentation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../randd.html">Research and Development</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="http://openems.io/javadoc">Javadoc</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Open Energy Management System</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Open Energy Management System</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../introduction.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../introduction.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="../introduction.html">Open Energy Management System</a></li>
    <li class="crumb">OpenEMS Edge</li>
    <li class="crumb"><a href="implement.html">Implementing a Device</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/travis/build/OpenEMS/openems/doc/modules/ROOT/pages/edge/implement.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Implementing a device</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_step_by_step_guide">1. Step-by-step guide</a>
<ul class="sectlevel2">
<li><a href="#_create_a_new_osgi_bundle">1.1. Create a new OSGi Bundle</a></li>
<li><a href="#_define_bundle_dependencies">1.2. Define Bundle dependencies</a></li>
<li><a href="#_define_configuration_parameters">1.3. Define configuration parameters</a></li>
<li><a href="#_initialize_channels">1.4. Initialize Channels</a></li>
<li><a href="#_implement_the_openems_component">1.5. Implement the OpenEMS Component</a></li>
<li><a href="#_start_the_device_simulator">1.6. Start the device simulator</a></li>
<li><a href="#_enable_the_component">1.7. Enable the Component</a></li>
<li><a href="#_run_the_implementation">1.8. Run the implementation</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_step_by_step_guide"><a class="anchor" href="#_step_by_step_guide"></a>1. Step-by-step guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter explains the steps required to implement a meter in OpenEMS Edge that is connected via Modbus/TCP. The meter itself is simulated using a small Modbus slave application, so no external hardware is required for this guide.</p>
</div>
<div class="paragraph">
<p>The tutorial is based on the <a href="../gettingstarted.html" class="page">Getting Started</a> guide.</p>
</div>
<div class="sect2">
<h3 id="_create_a_new_osgi_bundle"><a class="anchor" href="#_create_a_new_osgi_bundle"></a>1.1. Create a new OSGi Bundle</h3>
<div class="paragraph">
<p>For more information see <a href="../coreconcepts.html#_osgi_bundle" class="page">OSGi Bundle</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the menu choose <b class="button">File</b> &#8594; <b class="button">New</b> &#8594; <b class="button">Other</b></p>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-file-new-other.png" alt="Creating a new project in Eclipse IDE">
</div>
<div class="title">Figure 1. Creating a new project in Eclipse IDE</div>
</div>
</li>
<li>
<p>Select <b class="button">Bndtools</b> &#8594; <b class="button">Bnd OSGi Project</b> and press <b class="button">Next &gt;</b></p>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-bndtools-osgi-project.png" alt="Creating a Bnd OSGi Project in Eclipse IDE">
</div>
<div class="title">Figure 2. Creating a Bnd OSGi Project in Eclipse IDE</div>
</div>
</li>
<li>
<p>Select <b class="button">OSGi enRoute</b> &#8594; <b class="button">Provider/Adapter Bundle</b> and press <b class="button">Next &gt;</b></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Technically an OpenEMS Edge Device provides implementations of the interfaces of an OSGi <em>API Bundle</em>. In OSGi terminology this is called a <em>Provider/Adapter Bundle</em>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-new-osgi-provider-bundle.png" alt="Creating a Bnd OSGi Provider/Adapter Bundle in Eclipse IDE">
</div>
<div class="title">Figure 3. Creating a Bnd OSGi Provider/Adapter Bundle in Eclipse IDE</div>
</div>
</li>
<li>
<p>Choose a project name and press <b class="button">Next &gt;</b></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The project name is used as the folder name in OpenEMS source directory. The naming is up to you, but it is good practice to keep the name lower case and use something like <strong>io.openems.[edge/backend].[purpose/nature].[implementation]</strong>. For the simulated meter <code>io.openems.edge.meter.simulated</code> is a good choice.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-new-osgi-provider-simulatedmeter.png" alt="Naming a Bnd OSGi Provider/Adapter Bundle in Eclipse IDE">
</div>
<div class="title">Figure 4. Naming a Bnd OSGi Provider/Adapter Bundle in Eclipse IDE</div>
</div>
</li>
<li>
<p>Accept defaults for the final screen and press <b class="button">Finish</b></p>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-new-osgi-provider-simulatedmeter-final.png" alt="Java settings for a Bnd OSGi Provider/Adapter Bundle in Eclipse IDE">
</div>
<div class="title">Figure 5. Java settings for a Bnd OSGi Provider/Adapter Bundle in Eclipse IDE</div>
</div>
</li>
<li>
<p>The assistant closes and you can see your new bundle.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_define_bundle_dependencies"><a class="anchor" href="#_define_bundle_dependencies"></a>1.2. Define Bundle dependencies</h3>
<div class="paragraph">
<p>OSGi Bundles can be dependent on certain other Bundles. This information needs to be set in a <strong>bnd.bnd</strong> file.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Select the component directory <b class="button">src</b> &#8594; <b class="button">io.openems.edge.meter.simulated</b></p>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-new-simulatedmeter-bundle.png" alt="New simulated meter Bnd OSGi Provider/Adapter Bundle in Eclipse IDE">
</div>
<div class="title">Figure 6. New simulated meter Bnd OSGi Provider/Adapter Bundle in Eclipse IDE</div>
</div>
</li>
<li>
<p>Open the <b class="button">bnd.bnd</b> file by double clicking on it.</p>
</li>
<li>
<p>Open the <b class="button">Build</b> tab</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can see, that the Bundle is currently dependent on a core OSGi API bundle ('osgi.enroute.base.api'). We are going to expand that list.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-bnd-file-build.png" alt="Bndtools Build configuration">
</div>
<div class="title">Figure 7. Bndtools Build configuration</div>
</div>
</li>
<li>
<p>Click the <b class="button">+</b> symbol next to <strong>Build Path</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-osgi-build-path.png" alt="Bndtools Build Path configuration">
</div>
<div class="title">Figure 8. Bndtools Build Path configuration</div>
</div>
</li>
<li>
<p>Use the <strong>Project Build Path</strong> assistant to add the following Bundles as dependencies:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">io.openems.edge.common</dt>
<dd>
<p>The Edge Common Bundle provides implementations and services that are common to all OpenEMS Edge components.</p>
</dd>
<dt class="hdlist1">io.openems.edge.meter.api</dt>
<dd>
<p>The Meter API Bundle provides the interfaces for OpenEMS Edge Meter Nature.</p>
</dd>
<dt class="hdlist1">io.openems.edge.bridge.modbus</dt>
<dd>
<p>The Modbus Bundle provides the Bridge services for Modbus/RTU and Modbus/TCP protocols.</p>
</dd>
</dl>
</div>
</li>
<li>
<p>It is also a good moment to configure the Bundle meta information. Still inside the <b class="button">bnd.bnd</b> file open the <b class="button">Source</b> tab. Add some meta information - it will help the users of your component:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>Bundle-Name: OpenEMS Edge Meter Simulated
Bundle-Vendor: FENECON GmbH
Bundle-License: https://opensource.org/licenses/EPL-2.0
Bundle-Version: 1.0.0.${tstamp}
Export-Package: \
	io.openems.edge.meter.api,\
	io.openems.edge.meter.asymmetric.api,\
	io.openems.edge.meter.symmetric.api
Private-Package: io.openems.edge.meter.simulated

-includeresource: {readme.md}

-buildpath: \
	osgi.enroute.base.api;version=2.1,\
	io.openems.edge.meter.api;version=latest,\
	io.openems.edge.bridge.modbus;version=latest,\
	io.openems.edge.common;version=latest

-testpath: \
	osgi.enroute.junit.wrapper;version=4.12, \
	osgi.enroute.hamcrest.wrapper;version=1.3</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_define_configuration_parameters"><a class="anchor" href="#_define_configuration_parameters"></a>1.3. Define configuration parameters</h3>
<div class="paragraph">
<p>OpenEMS Components can have several configuration parameters. They are defined as Java annotations and specific OSGi annotations are used to generate meta information that is used e.g. by Apache Felix Web Console to generate a user interface form (see <a href="../gettingstarted.html" class="page">Getting Started</a>).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that the component directory is still selected.</p>
</li>
<li>
<p>In the menu choose <b class="button">File</b> &#8594; <b class="button">New</b> &#8594; <b class="button">Other</b></p>
</li>
<li>
<p>Select <b class="button">Java</b> &#8594; <b class="button">Other&#8230;&#8203;</b> and press <b class="button">Next &gt;</b></p>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-new-annotation.png" alt="Creating a Java annotation in Eclipse IDE">
</div>
<div class="title">Figure 9. Creating a Java annotation in Eclipse IDE</div>
</div>
</li>
<li>
<p>Set the name <strong>Config</strong> press <b class="button">Finish</b>.</p>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-new-config-annotation.png" alt="Creating the Java annotation 'Config' in Eclipse IDE">
</div>
<div class="title">Figure 10. Creating the Java annotation 'Config' in Eclipse IDE</div>
</div>
</li>
<li>
<p>A Java annotation template was generated for you:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.openems.edge.meter.simulated;

public interface Config {

}</code></pre>
</div>
</div>
</li>
<li>
<p>Adjust the template to match the following code:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.openems.edge.meter.simulated;

import org.osgi.service.metatype.annotations.AttributeDefinition;
import org.osgi.service.metatype.annotations.ObjectClassDefinition;

import io.openems.edge.meter.api.MeterType;

@ObjectClassDefinition( <i class="conum" data-value="1"></i><b>(1)</b>
		name = "Meter Simulated", //
		description = "Implements the simulated meter.")
@interface Config {
	String service_pid(); <i class="conum" data-value="2"></i><b>(2)</b>

	String id() default "meter0"; <i class="conum" data-value="3"></i><b>(3)</b>

	boolean enabled() default true; <i class="conum" data-value="4"></i><b>(4)</b>

	@AttributeDefinition(name = "Meter-Type", description = "Grid, Production (=default), Consumption") <i class="conum" data-value="5"></i><b>(5)</b>
	MeterType type() default MeterType.PRODUCTION; <i class="conum" data-value="6"></i><b>(6)</b>

	@AttributeDefinition(name = "Modbus-ID", description = "ID of Modbus bridge.")
	String modbus_id(); <i class="conum" data-value="7"></i><b>(7)</b>

	@AttributeDefinition(name = "Modbus Unit-ID", description = "The Unit-ID of the Modbus device.")
	int modbusUnitId(); <i class="conum" data-value="8"></i><b>(8)</b>

	@AttributeDefinition(name = "Modbus target filter", description = "This is auto-generated by 'Modbus-ID'.")
	String Modbus_target() default ""; <i class="conum" data-value="9"></i><b>(9)</b>

	String webconsole_configurationFactory_nameHint() default "Meter Simulated [{id}]"; <i class="conum" data-value="10"></i><b>(10)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <strong>@ObjectClassDefinition</strong> annotation defines this file as a Meta Type Resource for OSGi configuration admin. Use it to set a <em>name</em> and <em>description</em> for this OpenEMS Component.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <strong>service_pid</strong> is used in internally by OpenEMS Edge framework and is automatically filled by OSGi.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <strong>id</strong> configuration parameter sets the OpenEMS Component-ID (see <a href="../coreconcepts.html" class="page">Channel Adress</a>). <em>Note</em>: A <strong>default</strong> ID 'meter0' is defined. It is good practice to define such an ID here, as it simplifies configuration in the UI.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <strong>enabled</strong> parameter provides a <em>soft</em> way of deactivating an OpenEMS Component programmatically.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <strong>@AttributeDefinition</strong> annotation provides meta information about a configuration parameter like <em>name</em> and <em>description</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The 'Meter' nature requires definition of a MeterType that defines the purpose of the Meter. We will let the user define this type by a configuration parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The 'Modbus-ID' parameter creates the link to a Modbus-Service via its OpenEMS Component-ID. At runtime the user will typically set this configuration parameter to something like 'modbus0'.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The Modbus service implementation requires us to provide the Modbus <em>Unit-ID</em> (also commonly called <em>Device-ID</em> or <em>Slave-ID</em>) of the Modbus slave device. This is the ID that is configured at the simulated meter.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The <strong>Modbus_target</strong> will be automatically set by OpenEMS framework and does usually not need to be configured by the user. <em>Note</em>: Linking other OpenEMS Components is implemented using OSGi References. The OpenEMS Edge framework therefor sets the 'target' property of a reference to filter the matched services.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The <strong>webconsole_configurationFactory_nameHint</strong> parameter sets a custom name for Apache Felix Web Console, helping the user to find the correct bundle.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_initialize_channels"><a class="anchor" href="#_initialize_channels"></a>1.4. Initialize Channels</h3>
<div class="paragraph">
<p>Next step is to actually implement the OpenEMS Component as an OSGi Bundle.</p>
</div>
<div class="paragraph">
<p>The simulated meter is going to implement</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the "OpenemsComponent" nature - like every OpenEMS Component</p>
</li>
<li>
<p>the "SymmetricMeter" nature - for a three-phase symmetric meter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those natures require the simulated meter implementation to provide certain Channels, like "State" and "ActivePower". A common place to define and initialize those Channel-Objects is in a separate Utils class with a static <em>Utils.initializeChannels()</em> method. This method is later going to be called as early as possible by the component constructor, to be sure that the Channels are always defined and avoid NullPointerExceptions.</p>
</div>
<div class="paragraph">
<p>The initialization method uses Java Streams and Enums to facilitate the Definition of Channels.</p>
</div>
<div class="paragraph">
<p>Create a new file <strong>Utils.java</strong> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.openems.edge.meter.simulated;

import java.util.Arrays;
import java.util.stream.Stream;

import io.openems.edge.common.channel.AbstractReadChannel;
import io.openems.edge.common.channel.IntegerReadChannel;
import io.openems.edge.common.channel.StateCollectorChannel;
import io.openems.edge.common.component.OpenemsComponent;
import io.openems.edge.meter.api.SymmetricMeter;

public class Utils {
	public static Stream&lt;? extends AbstractReadChannel&lt;?&gt;&gt; initializeChannels(MeterSimulated c) { <i class="conum" data-value="1"></i><b>(1)</b>
		return Stream.of( //
				Arrays.stream(OpenemsComponent.ChannelId.values()).map(channelId -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
					switch (channelId) { <i class="conum" data-value="3"></i><b>(3)</b>
					case STATE:
						return new StateCollectorChannel(c, channelId); <i class="conum" data-value="4"></i><b>(4)</b>
					}
					return null;
				}), Arrays.stream(SymmetricMeter.ChannelId.values()).map(channelId -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
					switch (channelId) { <i class="conum" data-value="3"></i><b>(3)</b>
					case ACTIVE_POWER:
					case ACTIVE_CONSUMPTION_ENERGY:
					case ACTIVE_PRODUCTION_ENERGY:
					case CURRENT:
					case FREQUENCY:
					case MAX_ACTIVE_POWER:
					case MIN_ACTIVE_POWER:
					case REACTIVE_POWER:
					case VOLTAGE:
						return new IntegerReadChannel(c, channelId); <i class="conum" data-value="4"></i><b>(4)</b>
					}
					return null;
				})).flatMap(channel -&gt; channel);
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The static <strong>initializeChannels()</strong> method returns a Java Stream of Channel objects.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using Streams the Java lambda function is called for each declared ChannelId. This command is repeated for every Nature that is implemented by the OpenEMS Component.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Using a switch-case statement each ChannelId can be evaluated.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Because we are using enums together with switch-case, Eclipse IDE is able to find out if we covered every Channel and post a warning like 'The enum constant CURRENT needs a corresponding case label in this enum switch on SymmetricMeter.ChannelId'. Eclipse IDE 'Quick Fix' provides an option 'Add missing case statements' that will generate the missing switch-cases for you.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-channels-switch-case.png" alt="Eclipse IDE Quick Fix for switch-case">
</div>
<div class="title">Figure 11. Eclipse IDE Quick Fix for switch-case</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This line creates the actual Definition of the Channel and returns a Channel object instance of the required type.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_implement_the_openems_component"><a class="anchor" href="#_implement_the_openems_component"></a>1.5. Implement the OpenEMS Component</h3>
<div class="paragraph">
<p>The Bndtools assistant created a <code>ProviderImpl.java</code> file. First step is to set a proper name for this file. To rename the file, select it by clicking on it and choose <b class="button">Refactor</b> &#8594; <b class="button">Rename&#8230;&#8203;</b> in the menu. Write <code>MeterSimulated</code> as 'New name' and press <b class="button">Finish</b>.</p>
</div>
<div class="paragraph">
<p>+
.Renaming a Java class in Eclipse IDE
image::eclipse-rename.png[Renaming a Java class in Eclipse IDE]</p>
</div>
<div class="paragraph">
<p>+
Afterwards replace the content of <code>MeterSimulated.java</code> file with the following code:</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.openems.edge.meter.simulated;

import org.osgi.service.cm.ConfigurationAdmin;
import org.osgi.service.component.ComponentContext;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.ConfigurationPolicy;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.component.annotations.ReferenceCardinality;
import org.osgi.service.component.annotations.ReferencePolicy;
import org.osgi.service.component.annotations.ReferencePolicyOption;
import org.osgi.service.metatype.annotations.Designate;

import io.openems.edge.bridge.modbus.api.AbstractOpenemsModbusComponent;
import io.openems.edge.bridge.modbus.api.BridgeModbus;
import io.openems.edge.bridge.modbus.api.ModbusProtocol;
import io.openems.edge.bridge.modbus.api.element.SignedWordElement;
import io.openems.edge.bridge.modbus.api.task.FC3ReadRegistersTask;
import io.openems.edge.common.channel.doc.Doc;
import io.openems.edge.common.component.OpenemsComponent;
import io.openems.edge.common.taskmanager.Priority;
import io.openems.edge.meter.api.MeterType;
import io.openems.edge.meter.api.SymmetricMeter;

@Designate(ocd = Config.class, factory = true) <i class="conum" data-value="1"></i><b>(1)</b>
@Component( <i class="conum" data-value="2"></i><b>(2)</b>
	name = "Meter.Simulated", <i class="conum" data-value="3"></i><b>(3)</b>
	immediate = true, <i class="conum" data-value="4"></i><b>(4)</b>
	configurationPolicy = ConfigurationPolicy.REQUIRE) <i class="conum" data-value="5"></i><b>(5)</b>
public class MeterSimulated extends AbstractOpenemsModbusComponent <i class="conum" data-value="6"></i><b>(6)</b>
	implements SymmetricMeter, OpenemsComponent { <i class="conum" data-value="7"></i><b>(7)</b>

	private MeterType meterType = MeterType.PRODUCTION;

	@Reference
	protected ConfigurationAdmin cm; <i class="conum" data-value="8"></i><b>(8)</b>

	public MeterSimulated() {
		Utils.initializeChannels(this).forEach(channel -&gt; this.addChannel(channel)); <i class="conum" data-value="9"></i><b>(9)</b>
	}

	@Reference(policy = ReferencePolicy.STATIC, policyOption = ReferencePolicyOption.GREEDY, cardinality = ReferenceCardinality.MANDATORY)
	protected void setModbus(BridgeModbus modbus) {
		super.setModbus(modbus); <i class="conum" data-value="10"></i><b>(10)</b>
	}

	@Activate
	void activate(ComponentContext context, Config config) { <i class="conum" data-value="11"></i><b>(11)</b>
		this.meterType = config.type();

		super.activate(context, config.service_pid(), config.id(), config.enabled(), config.modbusUnitId(), this.cm,
				"Modbus", config.modbus_id());
	}

	@Deactivate
	protected void deactivate() { <i class="conum" data-value="12"></i><b>(12)</b>
		super.deactivate();
	}

	public enum ChannelId implements io.openems.edge.common.channel.doc.ChannelId { <i class="conum" data-value="13"></i><b>(13)</b>
		;
		private final Doc doc;

		private ChannelId(Doc doc) {
			this.doc = doc;
		}

		public Doc doc() {
			return this.doc;
		}
	}

	@Override
	public MeterType getMeterType() { <i class="conum" data-value="14"></i><b>(14)</b>
		return this.meterType;
	}

	@Override
	protected ModbusProtocol defineModbusProtocol() { <i class="conum" data-value="15"></i><b>(15)</b>
		return new ModbusProtocol(this, <i class="conum" data-value="16"></i><b>(16)</b>
				new FC3ReadRegistersTask(1000, Priority.HIGH, <i class="conum" data-value="17"></i><b>(17)</b>
						m(SymmetricMeter.ChannelId.ACTIVE_POWER, new SignedWordElement(1000)))); <i class="conum" data-value="18"></i><b>(18)</b>
	}

	@Override
	public String debugLog() { <i class="conum" data-value="19"></i><b>(19)</b>
		return "L:" + this.getActivePower().value().asString();
	}
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <strong>@Designate</strong> annotation is used for OSGi to create a connection to the <em>Config</em> annotation class. It also defines this Component as a <em>factory</em>, i.e. it can produce multiple instances with different configurations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <strong>@Component</strong> annotation marks this class as an OSGi component.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <strong>name</strong> property sets the unique name of this component. It is used to store configuration in the filesystem, to identify the component inside Apache Felix Web Console, and so on. Configure a human-readable name in the form <strong>[nature].[vendor].[product]</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <strong>immediate</strong> property defines whether the component should be started immediately. Configure the Component to be started immediately after configuration, i.e. it is not waiting till its service is required by another Component.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <strong>configurationPolicy</strong> define that the configuration of the Component is required before it gets activated.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>To ease the implementation of a Modbus device we can extend the <strong>AbstractOpenemsModbusComponent</strong> class.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the device was using another protocol, it is advisable to use the <strong>AbstractOpenemsComponent</strong> class as a convenience layer instead of implementing everything required by the <strong>OpenemsComponent</strong> interface manually.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The class implements <strong>OpenemsComponent</strong>. This makes it an <a href="../coreconcepts.html#<em>openems_component" class="page">OpenEMS Component</a>.
The Device that we are is a <strong>SymmetricMeter</strong>. We already defined the required Channels in the _initializeChannels()</em> method. Additionally the Component also needs to implement the Nature interface.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In plain Java it is not required to add <code>implements OpenemsComponent</code> if we inherit from 'AbstractOpenemsComponent' or 'AbstractOpenemsModbusComponent'. Be aware that for OSGi dependency injection to function properly, it is still required to mention all implemented interfaces again, as it is not considering the complete inheritance tree.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The <code>super.activate()</code> method requires an instance of <strong>ConfigurationAdmin</strong> as a parameter. Using the <strong>@Reference</strong> annotation the OSGi framework is going to provide the ConfigurationAdmin service via dependency injection.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>In the constructor the <em>Utils.initializeChannels()</em> method is called to <strong>initialize Channels</strong>. It receives a Stream of Channel objects and adds all of them to the Component using the <code>addChannel()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The Component utilizes an external Modbus Component (the <em>Modbus Bridge</em>) for the actual Modbus communication. We receive an instance of this service via dependency injection (like we did already for the <em>ConfigurationAdmin</em> service). Most of the magic is handled by the <em>AbstractOpenemsModbusComponent</em> implementation, but the way the OSGi framework works, we need to define the <em>@Reference</em> explicitly here in the actual implementation of the component and call the parent <code>setModbus()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The <strong>activate()</strong> method (marked by the <strong>@Activate</strong> annotation) is called on activation of an object instance of this Component. It comes with a ComponentContext and an instance of a configuration in the form of a Config object. All logic for activating and deactivating the OpenEMS Component is hidden in the super classes and just needs to be called from here.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>The <strong>deactivate()</strong> method (marked by the <strong>@Deactivate</strong> annotation) is called on deactivation of the Component instance.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>The simulated implementation is only going to provide Channels defined by <em>OpenemsComponent</em> and <em>SymmetricMeter</em> natures. It is still good practice to add a skeleton for custom Channels to the Component implementation. We therefor add the <em>Channel Declaration</em> block inside the class.
<div class="paragraph">
<p>NOTE:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Channel declarations are <strong>enum</strong> types implementing the ChannelId interface.</p>
</li>
<li>
<p>This enum is empty, as we do not have custom Channels here.</p>
</li>
<li>
<p>ChannelId enums require a Doc object that provides meta information about the Channel - e.g. the above ACTIVE_POWER Channel is defined as <code>ACTIVE_POWER(new Doc().type(OpenemsType.INTEGER).unit(Unit.WATT)</code></p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>The SymmetricMeter Nature requires us to provide a <strong>MeterType</strong> via a <code>MeterType getMeterType()</code> method. The MeterType is provided by the Config.</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td><em>AbstractOpenemsModbusComponent</em> requires to implement a <strong>defineModbusProtocol()</strong> method that returns an instance of <strong>ModbusProtocol</strong>. The <em>ModbusProtocol</em> class maps Modbus addresses to OpenEMS Channels and provides some conversion utilities. Instantiation of a <em>ModbusProtocol</em> object uses the <a href="https://en.wikipedia.org/wiki/Builder_pattern#Java">Builder pattern <span class="icon"><i class="fa fa-external-link"></i></span></a></td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td>Creates a <strong>new ModbusProtocol</strong> instance. A reference to the component itself is the first parameter, followed by an arbitrary number of 'Tasks' (implemented as a Java varags array).</td>
</tr>
<tr>
<td><i class="conum" data-value="17"></i><b>17</b></td>
<td><strong>FC3ReadRegistersTask</strong> is an implementation of Modbus <a href="http://www.simplymodbus.ca/FC03.htm">function code 3 "Read Holding Registers" <span class="icon"><i class="fa fa-external-link"></i></span></a>. Its first parameter is the start address of the register block. The second parameter is a priority information that defines how often this register block needs to be queried. Following parameters are an arbitrary number of <strong>ModbusElements</strong>.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Most Modbus function codes are available by their respective <em>FC*</em> implementation classes.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="18"></i><b>18</b></td>
<td>Here the internal <strong>m()</strong> method is used to make a simple 1-to-1 mapping between the Modbus element at address <code>1000</code> and the Channel <em>SymmetricMeter.ChannelId.ACTIVE_POWER</em>. The Modbus element is defined as a 16 bit word element with an signed integer value.
<div class="paragraph">
<p>NOTE:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>m()</em> method also takes an instance of <strong>ElementToChannelConverter</strong> as an additional parameter. It can be used to add implicit unit conversions between Modbus element and OpenEMS Channel - like adding a scale factor that converts a read value of '95' to a channel value of '950'.</p>
</li>
<li>
<p>For Modbus registers that are empty or should be ignored, the <strong>DummyRegisterElement</strong> can be used.</p>
</li>
<li>
<p>For more advanced channel-to-element mapping functionalities the internal <strong>cm()</strong> method can be used - e.g. to map one Modbus element to multiple Channels.</p>
<div class="paragraph">
<p>Using this principle a complete Modbus table consisting of multiple register blocks that need to be read or written with different Modbus function codes can be defined. For details have a look at the existing implementation classes inside the Modbus Bridge source code.</p>
</div>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="19"></i><b>19</b></td>
<td>Finally it is always a good idea to define a <strong>debugLog()</strong> method. This method is called in each cycle by the <strong>Controller.Debug.Log</strong> and very helpful for continuous debugging.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_start_the_device_simulator"><a class="anchor" href="#_start_the_device_simulator"></a>1.6. Start the device simulator</h3>
<div class="paragraph">
<p>To start the device simulator, open the <b class="button">io.openems.edge.bridge.modbus</b> project and navigate to the <b class="button">test</b> &#8594; <b class="button">io.openems.edge.brige.modbus</b> folder. There you find the <b class="button">ModbusSlaveSimulator.java</b> file. Right-click that file and select <b class="button">Run As</b> &#8594; <b class="button">Java Application</b>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_enable_the_component"><a class="anchor" href="#_enable_the_component"></a>1.7. Enable the Component</h3>
<div class="paragraph">
<p>To enable the Component for running, open the <b class="button">io.openems.edge.application</b> project and open the <b class="button">EdgeApp.bndrun</b> file. Change to the <b class="button">Source</b> view and create two new lines to declare the new Component.</p>
</div>
<div class="paragraph">
<p>First: somewhere below <strong>-runrequires: \</strong> add
<code>osgi.identity;filter:='(osgi.identity=io.openems.edge.meter.simulated)',\</code></p>
</div>
<div class="paragraph">
<p>Second: somewhere below <strong>-runbundles: \</strong> add
<code>io.openems.edge.meter.simulated;version=snapshot,\</code></p>
</div>
<div class="paragraph">
<p>You may have found, that the entries are sorted alphabetically.</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_implementation"><a class="anchor" href="#_run_the_implementation"></a>1.8. Run the implementation</h3>
<div class="paragraph">
<p>Switch back to <b class="button">Run</b> view and press <b class="button">Run OSGi</b> to run OpenEMS Edge.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/eclipse-edgeapp-bndrun.png" alt="Eclipse IDE EdgeApp.bndrun">
</div>
<div class="title">Figure 12. Eclipse IDE EdgeApp.bndrun</div>
</div>
<div class="paragraph">
<p>From then you can configure your component as shown in <a href="../gettingstarted.html" class="page">Getting Started</a> guide. Add the following configurations inside Apache Felix Web Console:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Controller Debug Log</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>ID: <code>ctrlDebugLog0</code></p>
</li>
<li>
<p>Enabled: <code>checked</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Scheduler All Alphabetically</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>ID: <code>scheduler0</code></p>
</li>
<li>
<p>Enabled: <code>checked</code></p>
</li>
<li>
<p>Cycle time: <code>1000</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Bridge Modbus/TCP</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>ID: <code>modbus0</code></p>
</li>
<li>
<p>IP-Address: <code>localhost</code></p>
</li>
<li>
<p>Enabled: <code>checked</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Meter Simulated</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>ID: <code>meter0</code></p>
</li>
<li>
<p>Enabled: <code>checked</code></p>
</li>
<li>
<p>Meter-Type: <code>PRODUCTION</code></p>
</li>
<li>
<p>Modbus-ID: <code>modbus0</code></p>
</li>
<li>
<p>Modbus Unit-ID: <code>1</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In the Eclipse IDE console log you should see an output like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2018-11-14 23:03:03,898 [Executor] INFO  [e.controller.debuglog.DebugLog] [ctrlDebugLog0] _sum[Ess SoC:0 %|L:0 W Grid:0 W Production:500 W Consumption L:500 W] meter0[L:500 W]</pre>
</div>
</div>
<div class="paragraph">
<p>It shows a Production of <code>500 W</code> which is what is provided by the simulated meter device. Congrats!</p>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
